/*
 * EWP_Config.c
 *
 *  Created on: Apr 23, 2013
 *      Author: Daniel
 */
#include "Functions.h"
#include "Example_posspeed.h"   // Example specific Include file
void ConfigEpwm1(void);
void ConfigEpwm2(void);
void ConfigEpwm3(void);
void Config_Current_ADC(void);
POSSPEED qep_posspeed=POSSPEED_DEFAULTS;


void PeripheralConfig(void)
{
	Config_Current_ADC();
	qep_posspeed.init(&qep_posspeed);
	//Config_eQEP();
	//Config_PS_ADC();
	return;
}

void EPwmConfig(void)
{
	ConfigEpwm1();	//Inner Loop Timer
	ConfigEpwm2();	//Outer Loop Timer
	ConfigEpwm3();	//PWM Output
	return;
}
void ConfigEpwm1(void)
{
    // Assumes ePWM1 clock is already enabled in InitSysCtrl();

    // Time-base registers
	EPwm1Regs.TBCTL.bit.FREE_SOFT = 2;
    EPwm1Regs.TBPRD = Inner_Loop_Period;                // Set EPWM timer period
    EPwm1Regs.TBPHS.all = 0;                     		// Time-Base Phase Register
    EPwm1Regs.TBCTR = 0;                         		// Time-Base Counter Register
    EPwm1Regs.TBCTL.bit.PRDLD = TB_IMMEDIATE;    		// Set Immediate load
    EPwm1Regs.TBCTL.bit.CTRMODE = TB_COUNT_UPDOWN;   	// Count-up mode: used for asymmetric PWM
    EPwm1Regs.TBCTL.bit.PHSEN = TB_DISABLE;      		// Disable phase loading

    EPwm1Regs.AQCTLA.bit.ZRO = AQ_SET;             		// Set PWM1A on Zero
    EPwm1Regs.AQCTLA.bit.PRD = AQ_CLEAR;

    // Set TBCLK frequency
    EPwm1Regs.TBCTL.bit.HSPCLKDIV = TB_DIV1;     		// TBCLK = SYSCLKOUT
    EPwm1Regs.TBCTL.bit.CLKDIV = TB_DIV1;

    EPwm1Regs.ETSEL.bit.SOCAEN         = 1;      		// Enable SOC on A group
	EPwm1Regs.ETSEL.bit.SOCASEL        = 0x3;    		// Select SOC from CMPA/CMPC on up count
	EPwm1Regs.ETPS.bit.SOCAPRD         = 1;      		// Generate SOCA pulse on every 3rd event
    return;
}

void ConfigEpwm2( void )
{
    // Time-base registers
	EPwm2Regs.TBCTL.bit.FREE_SOFT = 2;
	EPwm2Regs.TBPRD = Outer_Loop_Period;                // Set EPWM timer period
    EPwm2Regs.TBPHS.all = 0;                     		// Time-Base Phase Register
    EPwm2Regs.TBCTR = 0;                         		// Time-Base Counter Register
    EPwm2Regs.TBCTL.bit.PRDLD = TB_IMMEDIATE;    		// Set Immediate load
    EPwm2Regs.TBCTL.bit.CTRMODE = TB_COUNT_UPDOWN;   	// Count-up mode: used for asymmetric PWM
    EPwm2Regs.TBCTL.bit.PHSEN = TB_DISABLE;      		// Disable phase loading
    // Set TBCLK frequency
    EPwm2Regs.TBCTL.bit.HSPCLKDIV = 6;     				// TBCLK = SYSCLKOUT
    EPwm2Regs.TBCTL.bit.CLKDIV = 3;

    EPwm2Regs.ETSEL.bit.INTSEL = ET_CTR_PRDZERO;       	// Select INT on Zero and PRD event
    EPwm2Regs.ETSEL.bit.INTEN = 1;    					// Enable INT
    EPwm2Regs.ETPS.bit.INTPRD = ET_1ST;            	 	// Generate INT on 1st event
    EPwm2Regs.TBCTR = 0x0000;                       	// Clear timer counter

    EPwm2Regs.AQCTLA.bit.ZRO = AQ_SET;             		// Set PWM2A on Zero
    EPwm2Regs.AQCTLA.bit.PRD = AQ_CLEAR;

    return;
}

void ConfigEpwm3(void)
{
    // Time-base registers
    EPwm3Regs.TBPRD = 3000;                        		// Set timer period
    EPwm3Regs.TBPHS.half.TBPHS = 0x0000;          		// Phase is 0
    EPwm3Regs.TBCTR = 0x0000;                      		// Clear counter

    // Setup TBCLK
    EPwm3Regs.TBCTL.bit.CTRMODE = TB_COUNT_UPDOWN; // Count up
    EPwm3Regs.TBCTL.bit.PHSEN = TB_DISABLE;       // Disable phase loading
    EPwm3Regs.TBCTL.bit.HSPCLKDIV = TB_DIV1;      // Clock ratio to SYSCLKOUT
    EPwm3Regs.TBCTL.bit.CLKDIV = TB_DIV1;         //
    // Setup compare
    EPwm3Regs.CMPA.half.CMPA = 1000;

    // Set actions
    EPwm3Regs.AQCTLA.bit.CAU = AQ_SET;             // Set PWM3A on Zero
    EPwm3Regs.AQCTLA.bit.CAD = AQ_CLEAR;
    return;
}

void Config_Current_ADC( void )
{
    // Configure ADC
    EALLOW;

    Adc1Regs.ADCCTL2.bit.ADCNONOVERLAP = 1;     // Set ADC to non-overlap mode

    Adc1Regs.ADCCTL1.bit.INTPULSEPOS   = 0;     // EOC trips after conversion result is latched
    Adc1Regs.INTSEL1N2.bit.INT1E       = 1;     // Enabled ADCINT1
    Adc1Regs.INTSEL1N2.bit.INT1CONT    = 0;     // Disable ADCINT1 Continuous mode
    Adc1Regs.INTSEL1N2.bit.INT1SEL     = 1;     // setup EOC1 to trigger ADCINT1

    // Select ADC input channels
    Adc1Regs.ADCSOC1CTL.bit.CHSEL      = 0;     // set SOC1 channel select to ADC1A2

    // Selecting triggers for SOCs
    AnalogSysctrlRegs.TRIG5SEL.all     = 5;     // Assigning EPWM1SOCA to TRIGGER 6 of analog subsystem

    Adc1Regs.ADCSOC1CTL.bit.TRIGSEL    = 9;    // Assign EPWM1SOCA to SOC1 TRIGSEL

    // Set S/H window of 7 ADC clock cycles
    Adc1Regs.ADCSOC1CTL.bit.ACQPS      = 6;

    EDIS;
    return;
}


